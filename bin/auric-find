#!/bin/zsh

: ${MUSIC:=~/music}
export MUSIC

main() {
    typeset opt filter=short-display
    typeset -a grepargs
    grepargs=( -i )
    while getopts :lwi opt; do
        case $opt in
            (l) filter=long-display ;;
            ([wi]) grepargs+=( $opt ) ;;
        esac
    done
    shift $(( OPTIND - 1 ))

    fgrep $grepargs "$@" $MUSIC/**/metadata | $filter
}

short-display() {
    perl -ne '
    if (m{^$ENV{MUSIC}/([^:]+)/metadata:(\.) (\w+) (.+)}) {
        my ($obj, $key, $fld, $val) = ($1, $2, $3, $4);
        $key = $key eq "." ? $obj : "$obj/$key";
        print "$key $fld $val\n";
    }'
}

long-display() {
    perl -ne 'print "$1 $2\n" if m{/([^/]+)/metadata:\. (?:title|album) (.+)}'
}

main "$@"
